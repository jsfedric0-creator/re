server {
    listen 8080;
    server_name swift-elysha-livedash-6fda543b.koyeb.app;
    
    # Main BEIN SPORTS stream
    location /bein1 {
        proxy_pass http://135.125.109.73:9000/beinsporten1_.m3u8;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 300s;
        
        add_header Access-Control-Allow-Origin *;
        add_header Cache-Control "no-cache";
        add_header X-Stream-Source "BEIN SPORTS ENGLISH 1";
    }
    
    # Alternative URLs
    location /stream/ {
        rewrite ^/stream/(.*)$ /$1 last;
    }
    
    location /live/ {
        rewrite ^/live/(.*)$ /$1 last;
    }
    
    location /channel/ {
        rewrite ^/channel/(.*)$ /$1 last;
    }
    
    # M3U8 endpoint
    location ~ \.m3u8$ {
        proxy_pass http://135.125.109.73:9000/beinsporten1_.m3u8;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 300s;
        
        # M3U8 specific headers
        add_header Content-Type "application/vnd.apple.mpegurl";
        add_header Access-Control-Allow-Origin *;
        add_header Cache-Control "no-cache";
    }
    
    # Playlist
    location /playlist.m3u {
        default_type application/vnd.apple.mpegurl;
        alias /usr/share/nginx/html/playlist.m3u;
        
        add_header Access-Control-Allow-Origin *;
        add_header Cache-Control "no-cache";
    }
    
    # Web interface
    location / {
        root /usr/share/nginx/html;
        index index.html;
        
        # Redirect to streaming URLs
        if ($args ~* "stream") {
            return 302 /bein1;
        }
        if ($args ~* "m3u8") {
            return 302 /bein1.m3u8;
        }
    }
    
    # Health check for Koyeb
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
