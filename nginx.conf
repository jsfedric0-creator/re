worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

# Load RTMP module
load_module modules/ngx_rtmp_module.so;

events {
    worker_connections 1024;
}

# RTMP Configuration for Restreaming
rtmp {
    server {
        listen 1935;
        chunk_size 4096;
        ping 30s;
        ping_timeout 10s;
        buflen 5s;
        
        # Application for live streaming
        application live {
            live on;
            record off;
            meta copy;
            
            # ===== INPUT from your sources =====
            # Pull from source 1
            pull http://47.236.154.101/redirect.php?id=227570 name=bein-max1 static;
            pull http://47.236.154.101/redirect.php?id=227571 name=bein-max2 static;
            pull http://47.236.154.101/redirect.php?id=67374 name=bein-news static;
            pull http://47.236.154.101/redirect.php?id=67373 name=bein-hd static;
            
            # Pull from source 2
            pull http://live.lynxiptv.xyz/334188914694/bLe8QR48ko/227570 name=lynx-max1 static;
            pull http://live.lynxiptv.xyz/334188914694/bLe8QR48ko/227571 name=lynx-max2 static;
            pull http://live.lynxiptv.xyz/334188914694/bLe8QR48ko/67374 name=lynx-news static;
            
            # Pull from source 3
            pull http://off25.lynxcontents.click:2086/334188914694/bLe8QR48ko/227570?data=kGuDfVLrAdTwnNcX36JVmrhHBFqnjCQGXi-LBi28R7kobiie91fZCHM9ieYltHrTAItALSVlmW12DBWVeaX4s31bhBZ5jbXRWqskUtKCrrhpxaq0-N2JblWGXjhglxeRPN44r4payRYI9cAhBfOXbQ%3D%3D&expires=1768521431 name=off-max1 static;
            
            # ===== HLS OUTPUT =====
            hls on;
            hls_path /tmp/hls;
            hls_fragment 3s;
            hls_playlist_length 60s;
            hls_nested on;
            hls_cleanup on;
            hls_type live;
            
            # ===== RESTREAM TO OTHER PLATFORMS =====
            # ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØµØ§Øª Ù„Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù‡Ù†Ø§
            # push rtmp://live.twitch.tv/app/YOUR_STREAM_KEY;
            # push rtmp://a.rtmp.youtube.com/live2/YOUTUBE_STREAM_KEY;
            # push rtmp://live-api-s.facebook.com:80/rtmp/FB_PAGE_ID?stream_key=XXX;
            
            # ===== MULTI-BITRATE (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) =====
            # exec ffmpeg -i rtmp://localhost:1935/live/$name 
            #   -c:a copy -c:v libx264 -preset veryfast -b:v 3000k -maxrate 3000k -bufsize 6000k 
            #   -f flv rtmp://localhost:1935/hls/$name_1080p 2>>/tmp/ffmpeg_$name.log;
            
            # exec ffmpeg -i rtmp://localhost:1935/live/$name 
            #   -c:a copy -c:v libx264 -preset veryfast -b:v 1500k -maxrate 1500k -bufsize 3000k 
            #   -s 1280x720 -f flv rtmp://localhost:1935/hls/$name_720p 2>>/tmp/ffmpeg_$name.log;
        }
        
        # Application for HLS only
        application hls {
            live on;
            hls on;
            hls_path /tmp/hls;
            hls_fragment 3s;
            hls_playlist_length 60s;
            deny publish all;
            allow play all;
        }
    }
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    
    # Cache for HLS
    proxy_cache_path /tmp/nginx-cache levels=1:2 keys_zone=hls_cache:10m max_size=10g inactive=60m;
    
    # HTTP Server for HLS
    server {
        listen 8080;
        server_name _;
        
        # ===== HLS PLAYBACK =====
        location /hls {
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }
            alias /tmp/hls;
            add_header Cache-Control no-cache;
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Headers '*';
            add_header Access-Control-Allow-Methods 'GET, OPTIONS';
        }
        
        # ===== DIRECT STREAMS =====
        location /stream/max1 {
            # Restream to HTTP
            proxy_pass http://47.236.154.101/redirect.php?id=227570;
            proxy_set_header Host 47.236.154.101;
            proxy_set_header Accept-Encoding "";
            add_header Access-Control-Allow-Origin "*";
        }
        
        location /stream/max2 {
            proxy_pass http://47.236.154.101/redirect.php?id=227571;
            proxy_set_header Host 47.236.154.101;
            proxy_set_header Accept-Encoding "";
            add_header Access-Control-Allow-Origin "*";
        }
        
        location /stream/news {
            proxy_pass http://47.236.154.101/redirect.php?id=67374;
            proxy_set_header Host 47.236.154.101;
            proxy_set_header Accept-Encoding "";
            add_header Access-Control-Allow-Origin "*";
        }
        
        # ===== PLAYLIST GENERATOR =====
        location /playlist.m3u {
            default_type application/vnd.apple.mpegurl;
            add_header Content-Disposition 'attachment; filename="bein-restream.m3u"';
            add_header Access-Control-Allow-Origin "*";
            
            return 200 '#EXTM3U
#EXTINF:-1,beIN MAX 1 4K (RTMP)
rtmp://$host/live/bein-max1
#EXTINF:-1,beIN MAX 1 4K (HLS)
http://$host/hls/bein-max1/index.m3u8
#EXTINF:-1,beIN MAX 2 4K (RTMP)
rtmp://$host/live/bein-max2
#EXTINF:-1,beIN MAX 2 4K (HLS)
http://$host/hls/bein-max2/index.m3u8
#EXTINF:-1,beIN News HD (RTMP)
rtmp://$host/live/bein-news
#EXTINF:-1,beIN News HD (HLS)
http://$host/hls/bein-news/index.m3u8
#EXTINF:-1,beIN HD (RTMP)
rtmp://$host/live/bein-hd
#EXTINF:-1,beIN HD (HLS)
http://$host/hls/bein-hd/index.m3u8
#EXTINF:-1,beIN MAX 1 4K (Direct HTTP)
http://$host/stream/max1
#EXTINF:-1,beIN MAX 2 4K (Direct HTTP)
http://$host/stream/max2
#EXTINF:-1,beIN News HD (Direct HTTP)
http://$host/stream/news';
        }
        
        # ===== WEB DASHBOARD =====
        location / {
            add_header Content-Type text/html;
            return 200 '<!DOCTYPE html>
<html>
<head>
    <title>beIN Sports Restreaming Server</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: "Segoe UI", Arial, sans-serif; background: #0f172a; color: #f8fafc; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { text-align: center; padding: 40px 0; }
        h1 { font-size: 2.5em; margin-bottom: 10px; background: linear-gradient(90deg, #3b82f6, #8b5cf6); 
             -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; 
                 margin: 30px 0; }
        .stat-card { background: #1e293b; padding: 20px; border-radius: 10px; text-align: center; 
                     border: 1px solid #334155; }
        .stat-value { font-size: 2em; font-weight: bold; color: #60a5fa; }
        .channels { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
                    gap: 20px; margin-top: 30px; }
        .channel-card { background: #1e293b; border-radius: 10px; padding: 20px; border: 1px solid #334155; }
        .channel-name { font-size: 1.2em; font-weight: bold; color: #fbbf24; margin-bottom: 15px; 
                        display: flex; align-items: center; gap: 10px; }
        .stream-links { display: flex; flex-direction: column; gap: 10px; }
        .stream-link { display: flex; align-items: center; gap: 10px; padding: 10px; 
                       background: #374151; border-radius: 5px; text-decoration: none; 
                       color: #e5e7eb; transition: all 0.3s; }
        .stream-link:hover { background: #4b5563; transform: translateX(5px); }
        .protocol { background: #10b981; color: white; padding: 3px 8px; border-radius: 3px; 
                    font-size: 0.8em; }
        .rtmp { background: #f59e0b; }
        .hls { background: #3b82f6; }
        .http { background: #ef4444; }
        .m3u-section { text-align: center; margin: 40px 0; }
        .m3u-btn { display: inline-flex; align-items: center; gap: 10px; padding: 15px 30px; 
                   background: linear-gradient(90deg, #10b981, #059669); color: white; 
                   border-radius: 25px; text-decoration: none; font-weight: bold; font-size: 1.1em; }
        @media (max-width: 768px) { 
            .channels { grid-template-columns: 1fr; } 
            h1 { font-size: 2em; }
            .stats { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸŽ¬ beIN Sports Restreaming Server</h1>
            <p style="opacity: 0.8;">Real-time streaming with RTMP/HLS support</p>
        </header>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value">RTMP</div>
                <div>Live Streaming</div>
                <div style="font-size: 0.9em; opacity: 0.7; margin-top: 5px;">Port: 1935</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">HLS</div>
                <div>HTTP Streaming</div>
                <div style="font-size: 0.9em; opacity: 0.7; margin-top: 5px;">Port: 8080</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">3</div>
                <div>Source Servers</div>
                <div style="font-size: 0.9em; opacity: 0.7; margin-top: 5px;">Load Balanced</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">19+</div>
                <div>Channels</div>
                <div style="font-size: 0.9em; opacity: 0.7; margin-top: 5px;">beIN Sports</div>
            </div>
        </div>
        
        <div class="channels">
            <div class="channel-card">
                <div class="channel-name">ðŸŽ¬ beIN MAX 1 4K</div>
                <div class="stream-links">
                    <a href="rtmp://$host/live/bein-max1" class="stream-link">
                        <span class="protocol rtmp">RTMP</span>
                        <span>rtmp://$host/live/bein-max1</span>
                    </a>
                    <a href="/hls/bein-max1/index.m3u8" class="stream-link">
                        <span class="protocol hls">HLS</span>
                        <span>/hls/bein-max1/index.m3u8</span>
                    </a>
                    <a href="/stream/max1" class="stream-link">
                        <span class="protocol http">HTTP</span>
                        <span>/stream/max1</span>
                    </a>
                </div>
            </div>
            
            <div class="channel-card">
                <div class="channel-name">ðŸŽ¬ beIN MAX 2 4K</div>
                <div class="stream-links">
                    <a href="rtmp://$host/live/bein-max2" class="stream-link">
                        <span class="protocol rtmp">RTMP</span>
                        <span>rtmp://$host/live/bein-max2</span>
                    </a>
                    <a href="/hls/bein-max2/index.m3u8" class="stream-link">
                        <span class="protocol hls">HLS</span>
                        <span>/hls/bein-max2/index.m3u8</span>
                    </a>
                    <a href="/stream/max2" class="stream-link">
                        <span class="protocol http">HTTP</span>
                        <span>/stream/max2</span>
                    </a>
                </div>
            </div>
            
            <div class="channel-card">
                <div class="channel-name">ðŸ“° beIN News HD</div>
                <div class="stream-links">
                    <a href="rtmp://$host/live/bein-news" class="stream-link">
                        <span class="protocol rtmp">RTMP</span>
                        <span>rtmp://$host/live/bein-news</span>
                    </a>
                    <a href="/hls/bein-news/index.m3u8" class="stream-link">
                        <span class="protocol hls">HLS</span>
                        <span>/hls/bein-news/index.m3u8</span>
                    </a>
                    <a href="/stream/news" class="stream-link">
                        <span class="protocol http">HTTP</span>
                        <span>/stream/news</span>
                    </a>
                </div>
            </div>
        </div>
        
        <div class="m3u-section">
            <a href="/playlist.m3u" class="m3u-btn">
                <span>ðŸ“¥</span>
                <span>Download Complete M3U Playlist</span>
            </a>
            <p style="margin-top: 15px; opacity: 0.7;">
                Supports: VLC, OBS, FFmpeg, IPTV Players
            </p>
        </div>
    </div>
</body>
</html>';
        }
        
        # ===== RTMP STATS =====
        location /stats {
            rtmp_stat all;
            rtmp_stat_stylesheet stat.xsl;
        }
        
        location /stat.xsl {
            root /usr/share/nginx/html;
        }
        
        # ===== HEALTH CHECK =====
        location /health {
            return 200 "status: running\nservice: nginx-rtmp\ntime: $time_iso8601\n";
            add_header Content-Type text/plain;
        }
    }
}
