worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /tmp/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    
    # Cache settings
    proxy_cache_path /tmp/nginx-cache levels=1:2 keys_zone=iptv_cache:10m 
                     max_size=1g inactive=60m use_temp_path=off;
    
    # Log format
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    
    access_log /var/log/nginx/access.log main;
    
    server {
        listen 8080;
        server_name _;
        
        # Root - Channel list
        location = / {
            add_header Content-Type text/html;
            return 200 '<!DOCTYPE html>
<html>
<head>
    <title>beIN Sports IPTV Proxy</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { color: #333; }
        .channel { padding: 10px; border-bottom: 1px solid #ddd; }
        a { color: #0066cc; text-decoration: none; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <h1>beIN Sports Channels</h1>
    <p><a href="/playlist.m3u">ðŸ“º Download M3U Playlist</a></p>
    <div class="channel"><strong>beIN MAX 1 4K</strong> - <a href="/stream/227570">Stream</a></div>
    <div class="channel"><strong>beIN MAX 2 4K</strong> - <a href="/stream/227571">Stream</a></div>
    <div class="channel"><strong>beIN News HD</strong> - <a href="/stream/67374">Stream</a></div>
    <div class="channel"><strong>beIN HD</strong> - <a href="/stream/67373">Stream</a></div>
    <div class="channel"><strong>beIN Sports 1-9 HD</strong> - 
        <a href="/stream/67742">S1</a> | 
        <a href="/stream/67743">S2</a> | 
        <a href="/stream/67744">S3</a> | 
        <a href="/stream/67745">S4</a> | 
        <a href="/stream/67746">S5</a> | 
        <a href="/stream/67747">S6</a> | 
        <a href="/stream/67748">S7</a> | 
        <a href="/stream/67749">S8</a> | 
        <a href="/stream/67750">S9</a>
    </div>
    <p><a href="/health">ðŸ”§ Health Check</a></p>
</body>
</html>';
        }
        
        # Stream proxy
        location ~ ^/stream/([0-9]+)$ {
            set $channel_id $1;
            proxy_pass http://47.236.154.101/redirect.php?id=$channel_id;
            
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host 47.236.154.101;
            proxy_set_header Accept-Encoding "";
            
            proxy_buffering on;
            proxy_buffer_size 16k;
            proxy_buffers 4 32k;
            
            proxy_cache iptv_cache;
            proxy_cache_key "$scheme$host$request_uri";
            proxy_cache_valid 200 5m;
            
            add_header Access-Control-Allow-Origin "*";
            add_header Cache-Control "public, max-age=300";
        }
        
        # Playlist
        location = /playlist.m3u {
            default_type application/vnd.apple.mpegurl;
            add_header Content-Disposition 'attachment; filename="bein.m3u"';
            add_header Access-Control-Allow-Origin "*";
            
            return 200 '#EXTM3U
#EXTINF:-1,beIN MAX 1 4K
http://$host/stream/227570
#EXTINF:-1,beIN MAX 2 4K
http://$host/stream/227571
#EXTINF:-1,beIN News HD
http://$host/stream/67374
#EXTINF:-1,beIN HD
http://$host/stream/67373
#EXTINF:-1,beIN SPORTS 1 HD
http://$host/stream/67742
#EXTINF:-1,beIN SPORTS 2 HD
http://$host/stream/67743
#EXTINF:-1,beIN SPORTS 3 HD
http://$host/stream/67744
#EXTINF:-1,beIN SPORTS 4 HD
http://$host/stream/67745
#EXTINF:-1,beIN SPORTS 5 HD
http://$host/stream/67746
#EXTINF:-1,beIN SPORTS 6 HD
http://$host/stream/67747
#EXTINF:-1,beIN SPORTS 7 HD
http://$host/stream/67748
#EXTINF:-1,beIN SPORTS 8 HD
http://$host/stream/67749
#EXTINF:-1,beIN SPORTS 9 HD
http://$host/stream/67750
#EXTINF:-1,beIN XTRA 1 HD
http://$host/stream/219946
#EXTINF:-1,beIN XTRA 2 HD
http://$host/stream/219949
#EXTINF:-1,beIN XTRA 3 HD
http://$host/stream/222053
#EXTINF:-1,beIN AFC1 HD
http://$host/stream/219943
#EXTINF:-1,beIN AFC2 HD
http://$host/stream/222044
#EXTINF:-1,beIN AFC3 HD
http://$host/stream/222045';
        }
        
        # Health check
        location = /health {
            access_log off;
            return 200 "OK\n";
            add_header Content-Type text/plain;
        }
        
        # Error pages
        error_page 404 /404.html;
        location = /404.html {
            internal;
            return 404 'Not found';
        }
        
        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            internal;
            return 500 'Server error';
        }
    }
}
