worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /tmp/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    
    # Cache settings for better performance
    proxy_cache_path /tmp/nginx-cache levels=1:2 keys_zone=iptv_cache:10m 
                     max_size=2g inactive=60m use_temp_path=off;
    
    # Log format
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    
    access_log /var/log/nginx/access.log main;
    
    # Upstream server
    upstream origin_server {
        server 47.236.154.101:80;
        keepalive 16;
    }
    
    # Main server
    server {
        listen 8080;
        server_name _;
        
        # ========== ROOT - Channel List ==========
        location = / {
            add_header Content-Type text/html;
            return 200 '<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>beIN Sports - ÿ®ÿ±ŸàŸÉÿ≥Ÿä Koyeb</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; 
               background: linear-gradient(135deg, #1a237e 0%, #311b92 100%); 
               color: white; min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        header { text-align: center; padding: 40px 0; }
        h1 { font-size: 2.5em; margin-bottom: 10px; color: #ffd600; }
        .subtitle { font-size: 1.2em; opacity: 0.9; margin-bottom: 30px; }
        .stats { background: rgba(255,255,255,0.1); border-radius: 10px; 
                 padding: 20px; margin: 20px 0; display: grid; 
                 grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
                 gap: 15px; }
        .stat-item { text-align: center; padding: 15px; }
        .stat-value { font-size: 2em; font-weight: bold; display: block; color: #4caf50; }
        .channels-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
                         gap: 15px; margin-top: 30px; }
        .channel-card { background: rgba(255,255,255,0.1); border-radius: 8px; 
                        padding: 20px; transition: all 0.3s; border: 1px solid rgba(255,255,255,0.1); }
        .channel-card:hover { transform: translateY(-5px); background: rgba(255,255,255,0.15); 
                              border-color: #ffd600; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .channel-name { font-size: 1.2em; font-weight: bold; margin-bottom: 10px; 
                        color: #ffd600; display: flex; align-items: center; gap: 10px; }
        .channel-group { background: #2196f3; padding: 3px 10px; border-radius: 12px; 
                         font-size: 0.8em; }
        .channel-links { display: flex; gap: 10px; margin-top: 15px; }
        .btn { padding: 8px 16px; background: rgba(255,255,255,0.2); border-radius: 5px; 
               text-decoration: none; color: white; transition: all 0.3s; display: inline-flex; 
               align-items: center; gap: 5px; }
        .btn:hover { background: rgba(255,255,255,0.3); transform: scale(1.05); }
        .btn-primary { background: #4caf50; }
        .btn-stream { background: #ff5722; }
        .m3u-section { text-align: center; margin: 40px 0; padding: 30px; 
                       background: rgba(0,0,0,0.3); border-radius: 10px; }
        .m3u-btn { display: inline-flex; align-items: center; gap: 10px; padding: 15px 30px; 
                   background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%); 
                   border-radius: 25px; text-decoration: none; color: white; 
                   font-size: 1.2em; font-weight: bold; transition: all 0.3s; }
        .m3u-btn:hover { transform: scale(1.05); box-shadow: 0 10px 20px rgba(255,87,34,0.3); }
        footer { text-align: center; margin-top: 40px; padding-top: 20px; 
                 border-top: 1px solid rgba(255,255,255,0.1); opacity: 0.7; }
        @media (max-width: 768px) { 
            .channels-grid { grid-template-columns: 1fr; } 
            h1 { font-size: 1.8em; }
            .stats { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üì∫ beIN Sports - ÿ®ÿ±ŸàŸÉÿ≥Ÿä Koyeb</h1>
            <div class="subtitle">ÿ¨ŸÖŸäÿπ ŸÇŸÜŸàÿßÿ™ beIN ŸÖÿÆŸÅŸäÿ© ÿÆŸÑŸÅ ÿ®ÿ±ŸàŸÉÿ≥Ÿä ÿπÿßŸÑŸÖŸä</div>
        </header>
        
        <div class="stats">
            <div class="stat-item">
                <span class="stat-value">19</span>
                <span>ŸÇŸÜÿßÿ©</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">4K</span>
                <span>ÿ¨ŸàÿØÿ© ÿπÿßŸÑŸäÿ©</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">24/7</span>
                <span>ŸÖÿ™ÿßÿ≠ ÿØÿßÿ¶ŸÖÿßŸã</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">Koyeb</span>
                <span>ÿ¥ÿ®ŸÉÿ© ÿπÿßŸÑŸÖŸäÿ©</span>
            </div>
        </div>
        
        <div class="channels-grid">
            <div class="channel-card">
                <div class="channel-name"><span>üé¨</span> beIN MAX 1 4K <span class="channel-group">4K</span></div>
                <div class="channel-links">
                    <a href="/max1" class="btn btn-stream">‚ñ∂Ô∏è ÿ™ÿ¥ÿ∫ŸäŸÑ ŸÖÿ®ÿßÿ¥ÿ±</a>
                    <a href="/playlist.m3u#max1" class="btn">üìù ÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑÿ®ŸÑÿßŸäŸÑŸäÿ≥ÿ™</a>
                </div>
            </div>
            <div class="channel-card">
                <div class="channel-name"><span>üé¨</span> beIN MAX 2 4K <span class="channel-group">4K</span></div>
                <div class="channel-links">
                    <a href="/max2" class="btn btn-stream">‚ñ∂Ô∏è ÿ™ÿ¥ÿ∫ŸäŸÑ ŸÖÿ®ÿßÿ¥ÿ±</a>
                    <a href="/playlist.m3u#max2" class="btn">üìù ÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑÿ®ŸÑÿßŸäŸÑŸäÿ≥ÿ™</a>
                </div>
            </div>
            <div class="channel-card">
                <div class="channel-name"><span>üì∞</span> beIN News HD <span class="channel-group">ÿ£ÿÆÿ®ÿßÿ±</span></div>
                <div class="channel-links">
                    <a href="/news" class="btn btn-stream">‚ñ∂Ô∏è ÿ™ÿ¥ÿ∫ŸäŸÑ ŸÖÿ®ÿßÿ¥ÿ±</a>
                    <a href="/playlist.m3u#news" class="btn">üìù ÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑÿ®ŸÑÿßŸäŸÑŸäÿ≥ÿ™</a>
                </div>
            </div>
            <div class="channel-card">
                <div class="channel-name"><span>üì∫</span> beIN HD <span class="channel-group">ÿπÿßŸÖ</span></div>
                <div class="channel-links">
                    <a href="/hd" class="btn btn-stream">‚ñ∂Ô∏è ÿ™ÿ¥ÿ∫ŸäŸÑ ŸÖÿ®ÿßÿ¥ÿ±</a>
                    <a href="/playlist.m3u#hd" class="btn">üìù ÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑÿ®ŸÑÿßŸäŸÑŸäÿ≥ÿ™</a>
                </div>
            </div>
            <!-- Sports 1-9 -->
            <div class="channel-card">
                <div class="channel-name"><span>‚öΩ</span> beIN Sports 1-9 HD <span class="channel-group">ÿ±Ÿäÿßÿ∂ÿ©</span></div>
                <div class="channel-links">
                    <a href="/s1" class="btn btn-primary">Sports 1</a>
                    <a href="/s2" class="btn btn-primary">Sports 2</a>
                    <a href="/s3" class="btn btn-primary">Sports 3</a>
                    <a href="/s4" class="btn btn-primary">Sports 4</a>
                    <a href="/s5" class="btn btn-primary">Sports 5</a>
                </div>
            </div>
        </div>
        
        <div class="m3u-section">
            <a href="/playlist.m3u" class="m3u-btn">
                <span>üì•</span>
                <span>ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸÑÿßŸäŸÑŸäÿ≥ÿ™ ŸÉÿßŸÖŸÑÿ© (M3U)</span>
            </a>
            <p style="margin-top: 15px; opacity: 0.8; font-size: 0.9em;">
                ŸÖŸÜÿßÿ≥ÿ® ŸÑŸÄ: VLC, IPTV Smarters, TiviMate, OTT Navigator
            </p>
        </div>
        
        <footer>
            <p>Powered by Koyeb Global CDN ‚Ä¢ Nginx Reverse Proxy ‚Ä¢ ÿ•ÿÆŸÅÿßÿ° ÿ™ÿßŸÖ ŸÑŸÑÿ±Ÿàÿßÿ®ÿ∑</p>
        </footer>
    </div>
    
    <script>
        // Add more channels dynamically
        const sportsChannels = [
            {name: "beIN Sports 6 HD", id: "s6", num: 6},
            {name: "beIN Sports 7 HD", id: "s7", num: 7},
            {name: "beIN Sports 8 HD", id: "s8", num: 8},
            {name: "beIN Sports 9 HD", id: "s9", num: 9},
            {name: "beIN XTRA 1 HD", id: "xtra1"},
            {name: "beIN XTRA 2 HD", id: "xtra2"},
            {name: "beIN XTRA 3 HD", id: "xtra3"},
            {name: "beIN AFC1 HD", id: "afc1"},
            {name: "beIN AFC2 HD", id: "afc2"},
            {name: "beIN AFC3 HD", id: "afc3"}
        ];
        
        const grid = document.querySelector('.channels-grid');
        sportsChannels.forEach(ch => {
            const card = document.createElement('div');
            card.className = 'channel-card';
            card.innerHTML = `
                <div class="channel-name"><span>‚öΩ</span> ${ch.name} <span class="channel-group">ÿ±Ÿäÿßÿ∂ÿ©</span></div>
                <div class="channel-links">
                    <a href="/${ch.id}" class="btn btn-stream">‚ñ∂Ô∏è ÿ™ÿ¥ÿ∫ŸäŸÑ ŸÖÿ®ÿßÿ¥ÿ±</a>
                    <a href="/playlist.m3u#${ch.id}" class="btn">üìù ÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑÿ®ŸÑÿßŸäŸÑŸäÿ≥ÿ™</a>
                </div>
            `;
            grid.appendChild(card);
        });
    </script>
</body>
</html>';
        }
        
        # ========== DYNAMIC STREAM PROXY ==========
        # Generic proxy for all channels
        location ~ ^/proxy/([0-9]+)$ {
            set $channel_id $1;
            
            # Hide original URL completely
            proxy_pass http://origin_server/redirect.php?id=$channel_id;
            
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host 47.236.154.101;
            proxy_set_header Accept-Encoding "";
            proxy_set_header Referer "http://47.236.154.101/";
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Real-IP $remote_addr;
            
            # Hide origin server headers
            proxy_hide_header Server;
            proxy_hide_header X-Powered-By;
            proxy_hide_header Via;
            
            # Buffer settings
            proxy_buffering on;
            proxy_buffer_size 16k;
            proxy_buffers 4 32k;
            proxy_busy_buffers_size 64k;
            
            # Cache
            proxy_cache iptv_cache;
            proxy_cache_key "$scheme$host$request_uri";
            proxy_cache_valid 200 302 10m;
            proxy_cache_valid 404 1m;
            
            add_header Access-Control-Allow-Origin "*";
            add_header Cache-Control "public, max-age=300";
            add_header X-Proxy-Cache $upstream_cache_status;
            add_header X-Proxy-Server "Koyeb-CDN";
        }
        
        # ========== NAMED CHANNELS (Clean URLs) ==========
        # beIN MAX 1 4K
        location = /max1 {
            proxy_pass http://origin_server/redirect.php?id=227570;
            include proxy_settings.conf;
        }
        
        # beIN MAX 2 4K
        location = /max2 {
            proxy_pass http://origin_server/redirect.php?id=227571;
            include proxy_settings.conf;
        }
        
        # beIN News HD
        location = /news {
            proxy_pass http://origin_server/redirect.php?id=67374;
            include proxy_settings.conf;
        }
        
        # beIN HD
        location = /hd {
            proxy_pass http://origin_server/redirect.php?id=67373;
            include proxy_settings.conf;
        }
        
        # beIN Sports 1-9
        location = /s1 {
            proxy_pass http://origin_server/redirect.php?id=67742;
            include proxy_settings.conf;
        }
        location = /s2 {
            proxy_pass http://origin_server/redirect.php?id=67743;
            include proxy_settings.conf;
        }
        location = /s3 {
            proxy_pass http://origin_server/redirect.php?id=67744;
            include proxy_settings.conf;
        }
        location = /s4 {
            proxy_pass http://origin_server/redirect.php?id=67745;
            include proxy_settings.conf;
        }
        location = /s5 {
            proxy_pass http://origin_server/redirect.php?id=67746;
            include proxy_settings.conf;
        }
        location = /s6 {
            proxy_pass http://origin_server/redirect.php?id=67747;
            include proxy_settings.conf;
        }
        location = /s7 {
            proxy_pass http://origin_server/redirect.php?id=67748;
            include proxy_settings.conf;
        }
        location = /s8 {
            proxy_pass http://origin_server/redirect.php?id=67749;
            include proxy_settings.conf;
        }
        location = /s9 {
            proxy_pass http://origin_server/redirect.php?id=67750;
            include proxy_settings.conf;
        }
        
        # beIN XTRA
        location = /xtra1 {
            proxy_pass http://origin_server/redirect.php?id=219946;
            include proxy_settings.conf;
        }
        location = /xtra2 {
            proxy_pass http://origin_server/redirect.php?id=219949;
            include proxy_settings.conf;
        }
        location = /xtra3 {
            proxy_pass http://origin_server/redirect.php?id=222053;
            include proxy_settings.conf;
        }
        
        # beIN AFC
        location = /afc1 {
            proxy_pass http://origin_server/redirect.php?id=219943;
            include proxy_settings.conf;
        }
        location = /afc2 {
            proxy_pass http://origin_server/redirect.php?id=222044;
            include proxy_settings.conf;
        }
        location = /afc3 {
            proxy_pass http://origin_server/redirect.php?id=222045;
            include proxy_settings.conf;
        }
        
        # ========== ORIGINAL ID PATHS ==========
        location = /227570 {
            proxy_pass http://origin_server/redirect.php?id=227570;
            include proxy_settings.conf;
        }
        location = /227571 {
            proxy_pass http://origin_server/redirect.php?id=227571;
            include proxy_settings.conf;
        }
        location = /67374 {
            proxy_pass http://origin_server/redirect.php?id=67374;
            include proxy_settings.conf;
        }
        location = /67373 {
            proxy_pass http://origin_server/redirect.php?id=67373;
            include proxy_settings.conf;
        }
        location ~ ^/(6774[2-9]|67750)$ {
            proxy_pass http://origin_server/redirect.php?id=$1;
            include proxy_settings.conf;
        }
        location = /219946 {
            proxy_pass http://origin_server/redirect.php?id=219946;
            include proxy_settings.conf;
        }
        location = /219949 {
            proxy_pass http://origin_server/redirect.php?id=219949;
            include proxy_settings.conf;
        }
        location = /222053 {
            proxy_pass http://origin_server/redirect.php?id=222053;
            include proxy_settings.conf;
        }
        location = /219943 {
            proxy_pass http://origin_server/redirect.php?id=219943;
            include proxy_settings.conf;
        }
        location = /222044 {
            proxy_pass http://origin_server/redirect.php?id=222044;
            include proxy_settings.conf;
        }
        location = /222045 {
            proxy_pass http://origin_server/redirect.php?id=222045;
            include proxy_settings.conf;
        }
        
        # ========== M3U PLAYLIST ==========
        location = /playlist.m3u {
            default_type application/vnd.apple.mpegurl;
            add_header Content-Disposition 'attachment; filename="bein-sports-koyeb.m3u"';
            add_header Access-Control-Allow-Origin "*";
            add_header Cache-Control "public, max-age=3600";
            
            return 200 '#EXTM3U x-tvg-url="http://example.com/epg.xml"
#EXTINF:-1 tvg-id="beINMAX1.ae" tvg-name="beIN MAX 1 4K" tvg-logo="https://i.imgur.com/abc123.png" group-title="beIN 4K",beIN MAX 1 4K
http://$host/max1
#EXTINF:-1 tvg-id="beINMAX2.ae" tvg-name="beIN MAX 2 4K" tvg-logo="https://i.imgur.com/abc124.png" group-title="beIN 4K",beIN MAX 2 4K
http://$host/max2
#EXTINF:-1 tvg-id="beINNews.ae" tvg-name="beIN News HD" tvg-logo="https://i.imgur.com/abc125.png" group-title="beIN News",beIN News HD
http://$host/news
#EXTINF:-1 tvg-id="beIN.ae" tvg-name="beIN HD" tvg-logo="https://i.imgur.com/abc126.png" group-title="beIN Entertainment",beIN HD
http://$host/hd
#EXTINF:-1 tvg-id="beINSP1.ae" tvg-name="beIN SPORTS 1 HD" tvg-logo="https://i.imgur.com/abc127.png" group-title="beIN Sports",beIN SPORTS 1 HD
http://$host/s1
#EXTINF:-1 tvg-id="beINSP2.ae" tvg-name="beIN SPORTS 2 HD" tvg-logo="https://i.imgur.com/abc128.png" group-title="beIN Sports",beIN SPORTS 2 HD
http://$host/s2
#EXTINF:-1 tvg-id="beINSP3.ae" tvg-name="beIN SPORTS 3 HD" tvg-logo="https://i.imgur.com/abc129.png" group-title="beIN Sports",beIN SPORTS 3 HD
http://$host/s3
#EXTINF:-1 tvg-id="beINSP4.ae" tvg-name="beIN SPORTS 4 HD" tvg-logo="https://i.imgur.com/abc130.png" group-title="beIN Sports",beIN SPORTS 4 HD
http://$host/s4
#EXTINF:-1 tvg-id="beINSP5.ae" tvg-name="beIN SPORTS 5 HD" tvg-logo="https://i.imgur.com/abc131.png" group-title="beIN Sports",beIN SPORTS 5 HD
http://$host/s5
#EXTINF:-1 tvg-id="beINSP6.ae" tvg-name="beIN SPORTS 6 HD" tvg-logo="https://i.imgur.com/abc132.png" group-title="beIN Sports",beIN SPORTS 6 HD
http://$host/s6
#EXTINF:-1 tvg-id="beINSP7.ae" tvg-name="beIN SPORTS 7 HD" tvg-logo="https://i.imgur.com/abc133.png" group-title="beIN Sports",beIN SPORTS 7 HD
http://$host/s7
#EXTINF:-1 tvg-id="beINSP8.ae" tvg-name="beIN SPORTS 8 HD" tvg-logo="https://i.imgur.com/abc134.png" group-title="beIN Sports",beIN SPORTS 8 HD
http://$host/s8
#EXTINF:-1 tvg-id="beINSP9.ae" tvg-name="beIN SPORTS 9 HD" tvg-logo="https://i.imgur.com/abc135.png" group-title="beIN Sports",beIN SPORTS 9 HD
http://$host/s9
#EXTINF:-1 tvg-id="beINXTRA1.ae" tvg-name="beIN XTRA 1 HD" tvg-logo="https://i.imgur.com/abc136.png" group-title="beIN Sports",beIN XTRA 1 HD
http://$host/xtra1
#EXTINF:-1 tvg-id="beINXTRA2.ae" tvg-name="beIN XTRA 2 HD" tvg-logo="https://i.imgur.com/abc137.png" group-title="beIN Sports",beIN XTRA 2 HD
http://$host/xtra2
#EXTINF:-1 tvg-id="beINXTRA3.ae" tvg-name="beIN XTRA 3 HD" tvg-logo="https://i.imgur.com/abc138.png" group-title="beIN Sports",beIN XTRA 3 HD
http://$host/xtra3
#EXTINF:-1 tvg-id="beINAFC1.ae" tvg-name="beIN AFC1 HD" tvg-logo="https://i.imgur.com/abc139.png" group-title="beIN Sports",beIN AFC1 HD
http://$host/afc1
#EXTINF:-1 tvg-id="beINAFC2.ae" tvg-name="beIN AFC2 HD" tvg-logo="https://i.imgur.com/abc140.png" group-title="beIN Sports",beIN AFC2 HD
http://$host/afc2
#EXTINF:-1 tvg-id="beINAFC3.ae" tvg-name="beIN AFC3 HD" tvg-logo="https://i.imgur.com/abc141.png" group-title="beIN Sports",beIN AFC3 HD
http://$host/afc3';
        }
        
        # ========== HEALTH CHECK ==========
        location = /health {
            access_log off;
            return 200 "status: healthy\nservice: bein-proxy\ntime: $time_iso8601\n";
            add_header Content-Type text/plain;
        }
        
        # ========== STATS ==========
        location = /stats {
            stub_status on;
            access_log off;
        }
        
        # ========== ERROR PAGES ==========
        error_page 404 /404.html;
        location = /404.html {
            internal;
            return 404 '{"error": "ÿßŸÑŸÇŸÜÿßÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©", "code": 404}';
        }
        
        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            internal;
            return 500 '{"error": "ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿÆÿßÿØŸÖ", "code": 500}';
        }
    }
}

# Proxy settings file (optional but cleaner)
