worker_processes ${NGINX_WORKER_PROCESSES:-auto};
worker_rlimit_nofile 65535;
error_log /var/log/nginx/error.log warn;
pid /tmp/nginx.pid;

# Load dynamic modules
load_module modules/ngx_http_lua_module.so;
load_module modules/ngx_http_set_misc_module.so;
load_module modules/ngx_http_headers_more_filter_module.so;

events {
    worker_connections ${NGINX_WORKER_CONNECTIONS:-1024};
    use epoll;
    multi_accept on;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # Optimizations for streaming
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    server_tokens off;
    
    # Buffer settings
    client_body_buffer_size 128k;
    client_max_body_size 0;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 4k;
    output_buffers 1 32k;
    postpone_output 1460;
    
    # Timeouts
    client_body_timeout 60s;
    client_header_timeout 60s;
    send_timeout 60s;
    reset_timedout_connection on;
    
    # Cache settings
    proxy_cache_path /tmp/nginx-cache levels=1:2 keys_zone=iptv_cache:10m 
                     max_size=${CACHE_SIZE:-1g} inactive=60m use_temp_path=off;
    
    # Gzip compression (for M3U files)
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript 
               application/javascript application/xml application/json;
    
    # Log format with Koyeb headers
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    '$upstream_addr $upstream_response_time '
                    'koyeb_deployment:$http_x_koyeb_deployment '
                    'koyeb_service:$http_x_koyeb_service';
    
    access_log /var/log/nginx/access.log main buffer=32k flush=5s;
    
    # Rate limiting per IP
    limit_req_zone $binary_remote_addr zone=stream_limit:10m rate=10r/s;
    
    # Upstream with keepalive
    upstream origin_server {
        server 47.236.154.101:80;
        keepalive 16;
        keepalive_timeout 60s;
        keepalive_requests 100;
    }
    
    # Main server block
    server {
        listen 8080 reuseport;
        server_name _;
        
        # Root location with channel list
        location = / {
            add_header Content-Type text/html;
            return 200 '<!DOCTYPE html>
<html>
<head>
    <title>beIN Sports IPTV Proxy</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
               background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; 
               min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        header { text-align: center; padding: 40px 0; }
        h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .subtitle { font-size: 1.2em; opacity: 0.9; }
        .stats { background: rgba(255,255,255,0.1); border-radius: 10px; padding: 20px; 
                 margin: 20px 0; display: flex; justify-content: space-around; flex-wrap: wrap; }
        .stat-item { text-align: center; padding: 10px; }
        .stat-value { font-size: 2em; font-weight: bold; display: block; }
        .channels-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
                         gap: 20px; margin-top: 30px; }
        .channel-card { background: rgba(255,255,255,0.1); border-radius: 10px; padding: 20px; 
                        transition: transform 0.3s; }
        .channel-card:hover { transform: translateY(-5px); background: rgba(255,255,255,0.2); }
        .channel-name { font-size: 1.2em; font-weight: bold; margin-bottom: 10px; }
        .channel-links { display: flex; gap: 10px; margin-top: 10px; }
        .btn { padding: 8px 16px; background: rgba(255,255,255,0.2); border-radius: 5px; 
               text-decoration: none; color: white; transition: background 0.3s; }
        .btn:hover { background: rgba(255,255,255,0.3); }
        .btn-primary { background: #4CAF50; }
        .m3u-link { text-align: center; margin-top: 40px; }
        .m3u-btn { display: inline-block; padding: 15px 30px; background: #FF5722; 
                   border-radius: 25px; text-decoration: none; color: white; font-size: 1.2em; 
                   font-weight: bold; }
        footer { text-align: center; margin-top: 40px; opacity: 0.7; }
        @media (max-width: 768px) { 
            .channels-grid { grid-template-columns: 1fr; } 
            h1 { font-size: 2em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ“º beIN Sports IPTV Proxy</h1>
            <div class="subtitle">All beIN Sports channels restreamed through Koyeb CDN</div>
        </header>
        
        <div class="stats">
            <div class="stat-item">
                <span class="stat-value">19</span>
                <span>Channels</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">4K</span>
                <span>Ultra HD</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">24/7</span>
                <span>Availability</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">Global</span>
                <span>CDN</span>
            </div>
        </div>
        
        <div class="channels-grid" id="channels">
            <!-- Channels will be loaded by JavaScript -->
        </div>
        
        <div class="m3u-link">
            <a href="/playlist.m3u" class="m3u-btn">ðŸ“¥ Download Complete M3U Playlist</a>
        </div>
        
        <footer>
            <p>Powered by Koyeb â€¢ Nginx Reverse Proxy â€¢ Global CDN</p>
        </footer>
    </div>
    
    <script>
        const channels = [
            {name: "beIN MAX 1 4K", id: "227570", url: "/stream/227570", group: "4K"},
            {name: "beIN MAX 2 4K", id: "227571", url: "/stream/227571", group: "4K"},
            {name: "beIN News HD", id: "67374", url: "/stream/67374", group: "News"},
            {name: "beIN HD", id: "67373", url: "/stream/67373", group: "General"},
            {name: "beIN SPORTS 1 HD", id: "67742", url: "/stream/67742", group: "Sports"},
            {name: "beIN SPORTS 2 HD", id: "67743", url: "/stream/67743", group: "Sports"},
            {name: "beIN SPORTS 3 HD", id: "67744", url: "/stream/67744", group: "Sports"},
            {name: "beIN SPORTS 4 HD", id: "67745", url: "/stream/67745", group: "Sports"},
            {name: "beIN SPORTS 5 HD", id: "67746", url: "/stream/67746", group: "Sports"},
            {name: "beIN SPORTS 6 HD", id: "67747", url: "/stream/67747", group: "Sports"},
            {name: "beIN SPORTS 7 HD", id: "67748", url: "/stream/67748", group: "Sports"},
            {name: "beIN SPORTS 8 HD", id: "67749", url: "/stream/67749", group: "Sports"},
            {name: "beIN SPORTS 9 HD", id: "67750", url: "/stream/67750", group: "Sports"},
            {name: "beIN XTRA 1 HD", id: "219946", url: "/stream/219946", group: "Sports"},
            {name: "beIN XTRA 2 HD", id: "219949", url: "/stream/219949", group: "Sports"},
            {name: "beIN XTRA 3 HD", id: "222053", url: "/stream/222053", group: "Sports"},
            {name: "beIN AFC1 HD", id: "219943", url: "/stream/219943", group: "Sports"},
            {name: "beIN AFC2 HD", id: "222044", url: "/stream/222044", group: "Sports"},
            {name: "beIN AFC3 HD", id: "222045", url: "/stream/222045", group: "Sports"}
        ];
        
        const channelsGrid = document.getElementById("channels");
        channels.forEach(channel => {
            const card = document.createElement("div");
            card.className = "channel-card";
            card.innerHTML = `
                <div class="channel-name">${channel.name}</div>
                <div style="opacity: 0.8; font-size: 0.9em; margin-bottom: 10px;">Group: ${channel.group}</div>
                <div class="channel-links">
                    <a href="${channel.url}" class="btn" target="_blank">Stream</a>
                    <a href="/playlist.m3u#${channel.id}" class="btn btn-primary">Add to Playlist</a>
                </div>
            `;
            channelsGrid.appendChild(card);
        });
    </script>
</body>
</html>';
        }
        
        # ========== DYNAMIC STREAM PROXY ==========
        location ~ ^/stream/([0-9]+)$ {
            # Rate limiting
            limit_req zone=stream_limit burst=20 nodelay;
            
            # Extract channel ID
            set $channel_id $1;
            
            # Proxy to origin server
            proxy_pass http://origin_server/redirect.php?id=$channel_id;
            
            # Connection optimization
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Host 47.236.154.101;
            proxy_set_header Accept-Encoding "";
            
            # Timeouts
            proxy_connect_timeout 10s;
            proxy_send_timeout 300s;
            proxy_read_timeout 300s;
            
            # Buffering settings for streaming
            proxy_buffering on;
            proxy_buffer_size 16k;
            proxy_buffers 4 32k;
            proxy_busy_buffers_size 64k;
            proxy_temp_file_write_size 64k;
            
            # Cache settings
            proxy_cache iptv_cache;
            proxy_cache_key "$scheme$host$request_uri$http_range";
            proxy_cache_valid 200 302 ${CACHE_TIME:-5m};
            proxy_cache_valid 404 1m;
            proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
            proxy_cache_background_update on;
            
            # Range request support (for seeking)
            proxy_set_header Range $http_range;
            proxy_set_header If-Range $http_if_range;
            proxy_no_cache $http_range;
            
            # Security headers
            add_header X-Proxy "Koyeb-IPTV";
            add_header X-Cache-Status $upstream_cache_status;
            add_header Cache-Control "public, max-age=300";
            add_header Access-Control-Allow-Origin "*";
            add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";
            add_header Access-Control-Allow-Headers "Range, Origin, Accept-Encoding, Referer";
            add_header Access-Control-Expose-Headers "Content-Length, Content-Range";
            add_header Access-Control-Max-Age 86400;
            
            # CORS preflight
            if ($request_method = 'OPTIONS') {
                add_header Access-Control-Allow-Origin "*";
                add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";
                add_header Access-Control-Allow-Headers "Range, Origin, Accept-Encoding, Referer";
                add_header Access-Control-Max-Age 86400;
                add_header Content-Type "text/plain; charset=UTF-8";
                add_header Content-Length 0;
                return 204;
            }
        }
        
        # ========== NAMED CHANNEL ALIASES ==========
        location = /bein-max1 {
            return 302 /stream/227570;
        }
        location = /bein-max2 {
            return 302 /stream/227571;
        }
        location = /bein-news {
            return 302 /stream/67374;
        }
        location = /bein-hd {
            return 302 /stream/67373;
        }
        location ~ ^/bein-sports-([1-9])$ {
            set $num $1;
            return 302 /stream/6774$num;
        }
        location = /bein-xtra1 {
            return 302 /stream/219946;
        }
        location = /bein-xtra2 {
            return 302 /stream/219949;
        }
        location = /bein-xtra3 {
            return 302 /stream/222053;
        }
        location = /bein-afc1 {
            return 302 /stream/219943;
        }
        location = /bein-afc2 {
            return 302 /stream/222044;
        }
        location = /bein-afc3 {
            return 302 /stream/222045;
        }
        
        # ========== M3U PLAYLIST ==========
        location = /playlist.m3u {
            # Rate limiting for playlist
            limit_req zone=stream_limit burst=5;
            
            default_type application/vnd.apple.mpegurl;
            add_header Content-Disposition 'attachment; filename="bein-sports-koyeb.m3u"';
            add_header Access-Control-Allow-Origin "*";
            add_header Cache-Control "public, max-age=3600";
            
            # Generate dynamic M3U with all channels
            return 200 '#EXTM3U x-tvg-url="http://example.com/epg.xml"
#EXTINF:-1 tvg-id="beINMAX1.ae" tvg-name="beIN MAX 1 4K" tvg-logo="https://i.imgur.com/logo1.png" group-title="4K",beIN MAX 1 4K
http://$host/stream/227570
#EXTINF:-1 tvg-id="beINMAX2.ae" tvg-name="beIN MAX 2 4K" tvg-logo="https://i.imgur.com/logo2.png" group-title="4K",beIN MAX 2 4K
http://$host/stream/227571
#EXTINF:-1 tvg-id="beINNews.ae" tvg-name="beIN News HD" tvg-logo="https://i.imgur.com/logo3.png" group-title="News",beIN News HD
http://$host/stream/67374
#EXTINF:-1 tvg-id="beIN.ae" tvg-name="beIN HD" tvg-logo="https://i.imgur.com/logo4.png" group-title="General",beIN HD
http://$host/stream/67373
#EXTINF:-1 tvg-id="beINSP1.ae" tvg-name="beIN SPORTS 1 HD" tvg-logo="https://i.imgur.com/logo5.png" group-title="Sports",beIN SPORTS 1 HD
http://$host/stream/67742
#EXTINF:-1 tvg-id="beINSP2.ae" tvg-name="beIN SPORTS 2 HD" tvg-logo="https://i.imgur.com/logo6.png" group-title="Sports",beIN SPORTS 2 HD
http://$host/stream/67743
#EXTINF:-1 tvg-id="beINSP3.ae" tvg-name="beIN SPORTS 3 HD" tvg-logo="https://i.imgur.com/logo7.png" group-title="Sports",beIN SPORTS 3 HD
http://$host/stream/67744
#EXTINF:-1 tvg-id="beINSP4.ae" tvg-name="beIN SPORTS 4 HD" tvg-logo="https://i.imgur.com/logo8.png" group-title="Sports",beIN SPORTS 4 HD
http://$host/stream/67745
#EXTINF:-1 tvg-id="beINSP5.ae" tvg-name="beIN SPORTS 5 HD" tvg-logo="https://i.imgur.com/logo9.png" group-title="Sports",beIN SPORTS 5 HD
http://$host/stream/67746
#EXTINF:-1 tvg-id="beINSP6.ae" tvg-name="beIN SPORTS 6 HD" tvg-logo="https://i.imgur.com/logo10.png" group-title="Sports",beIN SPORTS 6 HD
http://$host/stream/67747
#EXTINF:-1 tvg-id="beINSP7.ae" tvg-name="beIN SPORTS 7 HD" tvg-logo="https://i.imgur.com/logo11.png" group-title="Sports",beIN SPORTS 7 HD
http://$host/stream/67748
#EXTINF:-1 tvg-id="beINSP8.ae" tvg-name="beIN SPORTS 8 HD" tvg-logo="https://i.imgur.com/logo12.png" group-title="Sports",beIN SPORTS 8 HD
http://$host/stream/67749
#EXTINF:-1 tvg-id="beINSP9.ae" tvg-name="beIN SPORTS 9 HD" tvg-logo="https://i.imgur.com/logo13.png" group-title="Sports",beIN SPORTS 9 HD
http://$host/stream/67750
#EXTINF:-1 tvg-id="beINXTRA1.ae" tvg-name="beIN XTRA 1 HD" tvg-logo="https://i.imgur.com/logo14.png" group-title="Sports",beIN XTRA 1 HD
http://$host/stream/219946
#EXTINF:-1 tvg-id="beINXTRA2.ae" tvg-name="beIN XTRA 2 HD" tvg-logo="https://i.imgur.com/logo15.png" group-title="Sports",beIN XTRA 2 HD
http://$host/stream/219949
#EXTINF:-1 tvg-id="beINXTRA3.ae" tvg-name="beIN XTRA 3 HD" tvg-logo="https://i.imgur.com/logo16.png" group-title="Sports",beIN XTRA 3 HD
http://$host/stream/222053
#EXTINF:-1 tvg-id="beINAFC1.ae" tvg-name="beIN AFC1 HD" tvg-logo="https://i.imgur.com/logo17.png" group-title="Sports",beIN AFC1 HD
http://$host/stream/219943
#EXTINF:-1 tvg-id="beINAFC2.ae" tvg-name="beIN AFC2 HD" tvg-logo="https://i.imgur.com/logo18.png" group-title="Sports",beIN AFC2 HD
http://$host/stream/222044
#EXTINF:-1 tvg-id="beINAFC3.ae" tvg-name="beIN AFC3 HD" tvg-logo="https://i.imgur.com/logo19.png" group-title="Sports",beIN AFC3 HD
http://$host/stream/222045';
        }
        
        # ========== STATISTICS ENDPOINT ==========
        location = /stats {
            auth_basic "Restricted";
            auth_basic_user_file /etc/nginx/.htpasswd;
            stub_status on;
            access_log off;
            allow 127.0.0.1;
            allow 10.0.0.0/8;
            deny all;
        }
        
        # ========== HEALTH CHECK ==========
        location = /health {
            access_log off;
            add_header Content-Type text/plain;
            
            # Simple health check that also verifies origin connectivity
            content_by_lua_block {
                local http = require "resty.http"
                local httpc = http.new()
                
                -- Check local nginx is running
                ngx.say("STATUS: OK")
                ngx.say("SERVICE: beIN IPTV Proxy")
                ngx.say("TIME: ", os.date("%Y-%m-%d %H:%M:%S"))
                ngx.say("UPSTREAM: 47.236.154.101")
                
                -- Try to connect to origin (non-blocking, async)
                local res, err = httpc:request_uri("http://47.236.154.101/", {
                    method = "HEAD",
                    timeout = 5000,
                    keepalive_timeout = 60
                })
                
                if res then
                    ngx.say("ORIGIN_STATUS: Reachable (", res.status, ")")
                else
                    ngx.say("ORIGIN_STATUS: Unreachable - ", err)
                end
                
                ngx.exit(200)
            }
        }
        
        # ========== METRICS FOR PROMETHEUS ==========
        location = /metrics {
            stub_status on;
            access_log off;
            
            content_by_lua_block {
                local metric = ngx.shared.metric
                local active = ngx.var.connections_active or 0
                local reading = ngx.var.connections_reading or 0
                local writing = ngx.var.connections_writing or 0
                local waiting = ngx.var.connections_waiting or 0
                local accepted = metric:get("connections_accepted") or 0
                local handled = metric:get("connections_handled") or 0
                local requests = metric:get("total_requests") or 0
                
                ngx.header.content_type = "text/plain"
                ngx.say("# HELP nginx_connections_active Active client connections")
                ngx.say("# TYPE nginx_connections_active gauge")
                ngx.say('nginx_connections_active ', active)
                
                ngx.say("# HELP nginx_connections_reading Connections where nginx is reading request header")
                ngx.say("# TYPE nginx_connections_reading gauge")
                ngx.say('nginx_connections_reading ', reading)
                
                ngx.say("# HELP nginx_connections_writing Connections where nginx is writing response back to client")
                ngx.say("# TYPE nginx_connections_writing gauge")
                ngx.say('nginx_connections_writing ', writing)
                
                ngx.say("# HELP nginx_connections_waiting Idle client connections")
                ngx.say("# TYPE nginx_connections_waiting gauge")
                ngx.say('nginx_connections_waiting ', waiting)
                
                ngx.say("# HELP nginx_connections_total_accepted Total accepted connections")
                ngx.say("# TYPE nginx_connections_total_accepted counter")
                ngx.say('nginx_connections_total_accepted ', accepted)
                
                ngx.say("# HELP nginx_connections_total_handled Total handled connections")
                ngx.say("# TYPE nginx_connections_total_handled counter")
                ngx.say('nginx_connections_total_handled ', handled)
                
                ngx.say("# HELP nginx_http_requests_total Total http requests")
                ngx.say("# TYPE nginx_http_requests_total counter")
                ngx.say('nginx_http_requests_total ', requests)
            }
        }
        
        # ========== FAVICON & ROBOTS ==========
        location = /favicon.ico {
            log_not_found off;
            access_log off;
            return 204;
        }
        
        location = /robots.txt {
            return 200 "User-agent: *\nDisallow: /\n";
        }
        
        # ========== ERROR PAGES ==========
        error_page 404 /404.html;
        location = /404.html {
            internal;
            return 404 '{"error": "Channel not found", "status": 404}';
        }
        
        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            internal;
            return 500 '{"error": "Server error", "status": 500}';
        }
        
        error_page 429 /429.html;
        location = /429.html {
            internal;
            return 429 '{"error": "Too many requests", "status": 429}';
        }
    }
}
