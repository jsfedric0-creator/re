worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
    use epoll;
    multi_accept on;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # Buffer optimizations for streaming
    client_body_buffer_size 128k;
    client_max_body_size 0;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 4k;
    output_buffers 1 32k;
    postpone_output 1460;
    
    # Timeouts
    client_body_timeout 60s;
    client_header_timeout 60s;
    send_timeout 60s;
    keepalive_timeout 75s;
    
    # Cache settings
    proxy_cache_path /tmp/nginx-cache levels=1:2 keys_zone=iptv_cache:10m 
                     max_size=1g inactive=60m use_temp_path=off;
    
    # Log format
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    '$upstream_addr $upstream_response_time';
    
    access_log /var/log/nginx/access.log main;
    
    # Upstream server (optional load balancing)
    upstream iptv_backend {
        server 47.236.154.101:80;
        keepalive 32;
    }
    
    # Main server block
    server {
        listen 80;
        server_name _;
        
        # ========== HLS RESTREAMING ==========
        # Convert MPEG-TS to HLS on-the-fly
        location ~ ^/hls/(.+)$ {
            # Extract channel ID from URL
            set $channel_id $1;
            
            # Proxy to original stream
            proxy_pass http://47.236.154.101/redirect.php?id=$channel_id;
            
            # Buffering settings for streaming
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
            proxy_busy_buffers_size 8k;
            
            # Headers
            proxy_set_header Host 47.236.154.101;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Cache settings
            proxy_cache iptv_cache;
            proxy_cache_key "$scheme$request_method$host$request_uri";
            proxy_cache_valid 200 302 5m;
            proxy_cache_valid 404 1m;
            
            # Don't modify the stream
            proxy_set_header Accept-Encoding "";
            
            add_header Cache-Control "public, max-age=5";
            add_header X-Cache-Status $upstream_cache_status;
            add_header Access-Control-Allow-Origin "*";
            add_header Access-Control-Allow-Methods "GET, OPTIONS";
            add_header Access-Control-Allow-Headers "Range";
            
            # Handle byte-range requests for seeking
            proxy_set_header Range $http_range;
            proxy_set_header If-Range $http_if_range;
            proxy_no_cache $http_range;
        }
        
        # ========== DIRECT PROXY (MPEG-TS) ==========
        location ~ ^/stream/([0-9]+)$ {
            proxy_pass http://47.236.154.101/redirect.php?id=$1;
            
            proxy_buffering off;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            
            proxy_set_header Host 47.236.154.101;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            
            proxy_read_timeout 300s;
            proxy_send_timeout 300s;
            
            # Important for video streaming
            proxy_set_header Accept-Encoding "";
            chunked_transfer_encoding off;
            
            add_header Access-Control-Allow-Origin "*";
            add_header Access-Control-Allow-Methods "GET, OPTIONS";
            add_header Cache-Control "no-cache";
        }
        
        # ========== NAMED CHANNELS ==========
        # beIN MAX 1 4K
        location /bein-max1 {
            proxy_pass http://47.236.154.101/redirect.php?id=227570;
            proxy_buffering off;
            proxy_set_header Accept-Encoding "";
            add_header Access-Control-Allow-Origin "*";
        }
        
        # beIN MAX 2 4K
        location /bein-max2 {
            proxy_pass http://47.236.154.101/redirect.php?id=227571;
            proxy_buffering off;
            proxy_set_header Accept-Encoding "";
            add_header Access-Control-Allow-Origin "*";
        }
        
        # beIN News HD
        location /bein-news {
            proxy_pass http://47.236.154.101/redirect.php?id=67374;
            proxy_buffering off;
            proxy_set_header Accept-Encoding "";
            add_header Access-Control-Allow-Origin "*";
        }
        
        # beIN HD
        location /bein-hd {
            proxy_pass http://47.236.154.101/redirect.php?id=67373;
            proxy_buffering off;
            proxy_set_header Accept-Encoding "";
            add_header Access-Control-Allow-Origin "*";
        }
        
        # beIN Sports 1-9
        location ~ ^/bein-sports-([1-9])$ {
            set $channel_num $1;
            proxy_pass http://47.236.154.101/redirect.php?id=6774$channel_num;
            proxy_buffering off;
            proxy_set_header Accept-Encoding "";
            add_header Access-Control-Allow-Origin "*";
        }
        
        # ========== M3U PLAYLIST GENERATOR ==========
        location /playlist.m3u {
            default_type application/vnd.apple.mpegurl;
            add_header Content-Disposition 'attachment; filename="koyeb-iptv.m3u"';
            add_header Access-Control-Allow-Origin "*";
            
            # Generate M3U playlist dynamically
            return 200 "#EXTM3U x-tvg-url=\"\"\n
#EXTINF:-1 tvg-id=\"beINMAX1.ae\" tvg-name=\"beIN MAX 1 4K\" tvg-logo=\"https://example.com/logo1.png\" group-title=\"Sports 4K\",beIN MAX 1 4K\n
http://$server_name/stream/227570\n
#EXTINF:-1 tvg-id=\"beINMAX2.ae\" tvg-name=\"beIN MAX 2 4K\" tvg-logo=\"https://example.com/logo2.png\" group-title=\"Sports 4K\",beIN MAX 2 4K\n
http://$server_name/stream/227571\n
#EXTINF:-1 tvg-id=\"beINNews.ae\" tvg-name=\"beIN News HD\" tvg-logo=\"https://example.com/logo3.png\" group-title=\"News\",beIN News HD\n
http://$server_name/stream/67374\n
#EXTINF:-1 tvg-id=\"beIN.ae\" tvg-name=\"beIN HD\" tvg-logo=\"https://example.com/logo4.png\" group-title=\"Entertainment\",beIN HD\n
http://$server_name/stream/67373\n
#EXTINF:-1 tvg-id=\"beINSP1.ae\" tvg-name=\"beIN SPORTS 1 HD\" tvg-logo=\"https://example.com/logo5.png\" group-title=\"Sports\",beIN SPORTS 1 HD\n
http://$server_name/stream/67742\n
#EXTINF:-1 tvg-id=\"beINSP2.ae\" tvg-name=\"beIN SPORTS 2 HD\" tvg-logo=\"https://example.com/logo6.png\" group-title=\"Sports\",beIN SPORTS 2 HD\n
http://$server_name/stream/67743\n
#EXTINF:-1 tvg-id=\"beINSP3.ae\" tvg-name=\"beIN SPORTS 3 HD\" tvg-logo=\"https://example.com/logo7.png\" group-title=\"Sports\",beIN SPORTS 3 HD\n
http://$server_name/stream/67744\n
#EXTINF:-1 tvg-id=\"beINSP4.ae\" tvg-name=\"beIN SPORTS 4 HD\" tvg-logo=\"https://example.com/logo8.png\" group-title=\"Sports\",beIN SPORTS 4 HD\n
http://$server_name/stream/67745\n
#EXTINF:-1 tvg-id=\"beINSP5.ae\" tvg-name=\"beIN SPORTS 5 HD\" tvg-logo=\"https://example.com/logo9.png\" group-title=\"Sports\",beIN SPORTS 5 HD\n
http://$server_name/stream/67746\n
#EXTINF:-1 tvg-id=\"beINSP6.ae\" tvg-name=\"beIN SPORTS 6 HD\" tvg-logo=\"https://example.com/logo10.png\" group-title=\"Sports\",beIN SPORTS 6 HD\n
http://$server_name/stream/67747\n
#EXTINF:-1 tvg-id=\"beINSP7.ae\" tvg-name=\"beIN SPORTS 7 HD\" tvg-logo=\"https://example.com/logo11.png\" group-title=\"Sports\",beIN SPORTS 7 HD\n
http://$server_name/stream/67748\n
#EXTINF:-1 tvg-id=\"beINSP8.ae\" tvg-name=\"beIN SPORTS 8 HD\" tvg-logo=\"https://example.com/logo12.png\" group-title=\"Sports\",beIN SPORTS 8 HD\n
http://$server_name/stream/67749\n
#EXTINF:-1 tvg-id=\"beINSP9.ae\" tvg-name=\"beIN SPORTS 9 HD\" tvg-logo=\"https://example.com/logo13.png\" group-title=\"Sports\",beIN SPORTS 9 HD\n
http://$server_name/stream/67750\n
#EXTINF:-1 tvg-id=\"beINXTRA1.ae\" tvg-name=\"beIN XTRA 1 HD\" tvg-logo=\"https://example.com/logo14.png\" group-title=\"Sports\",beIN XTRA 1 HD\n
http://$server_name/stream/219946\n
#EXTINF:-1 tvg-id=\"beINXTRA2.ae\" tvg-name=\"beIN XTRA 2 HD\" tvg-logo=\"https://example.com/logo15.png\" group-title=\"Sports\",beIN XTRA 2 HD\n
http://$server_name/stream/219949\n
#EXTINF:-1 tvg-id=\"beINXTRA3.ae\" tvg-name=\"beIN XTRA 3 HD\" tvg-logo=\"https://example.com/logo16.png\" group-title=\"Sports\",beIN XTRA 3 HD\n
http://$server_name/stream/222053\n
#EXTINF:-1 tvg-id=\"beINAFC1.ae\" tvg-name=\"beIN AFC1 HD\" tvg-logo=\"https://example.com/logo17.png\" group-title=\"Sports\",beIN AFC1 HD\n
http://$server_name/stream/219943\n
#EXTINF:-1 tvg-id=\"beINAFC2.ae\" tvg-name=\"beIN AFC2 HD\" tvg-logo=\"https://example.com/logo18.png\" group-title=\"Sports\",beIN AFC2 HD\n
http://$server_name/stream/222044\n
#EXTINF:-1 tvg-id=\"beINAFC3.ae\" tvg-name=\"beIN AFC3 HD\" tvg-logo=\"https://example.com/logo19.png\" group-title=\"Sports\",beIN AFC3 HD\n
http://$server_name/stream/222045\n";
        }
        
        # ========== CHANNELS LIST (HTML) ==========
        location /channels {
            default_type text/html;
            return 200 '<!DOCTYPE html>
<html>
<head>
    <title>beIN Sports Channels</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .channel { padding: 10px; border-bottom: 1px solid #ddd; }
        a { color: #0066cc; text-decoration: none; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <h1>beIN Sports Channels Proxy</h1>
    <p>Stream URLs:</p>
    <div class="channel">
        <strong>beIN MAX 1 4K</strong><br>
        <a href="/stream/227570">/stream/227570</a> | 
        <a href="/bein-max1">/bein-max1</a>
    </div>
    <div class="channel">
        <strong>beIN MAX 2 4K</strong><br>
        <a href="/stream/227571">/stream/227571</a> | 
        <a href="/bein-max2">/bein-max2</a>
    </div>
    <div class="channel">
        <strong>beIN News HD</strong><br>
        <a href="/stream/67374">/stream/67374</a> | 
        <a href="/bein-news">/bein-news</a>
    </div>
    <div class="channel">
        <strong>beIN Sports 1-9 HD</strong><br>
        <a href="/stream/67742">Sports 1</a> | 
        <a href="/stream/67743">Sports 2</a> | 
        <a href="/stream/67744">Sports 3</a> | 
        <a href="/stream/67745">Sports 4</a><br>
        <a href="/stream/67746">Sports 5</a> | 
        <a href="/stream/67747">Sports 6</a> | 
        <a href="/stream/67748">Sports 7</a> | 
        <a href="/stream/67749">Sports 8</a> | 
        <a href="/stream/67750">Sports 9</a>
    </div>
    <p><a href="/playlist.m3u">ðŸ“º Download M3U Playlist</a></p>
</body>
</html>';
        }
        
        # ========== HEALTH CHECK ==========
        location /health {
            access_log off;
            return 200 "OK\n";
            add_header Content-Type text/plain;
        }
        
        # ========== STATS ==========
        location /stats {
            stub_status on;
            access_log off;
            allow 127.0.0.1;
            deny all;
        }
        
        # ========== ERROR PAGES ==========
        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            root /usr/share/nginx/html;
        }
    }
    
    # ========== RTMP SERVER FOR RESTREAMING ==========
    # Optional: Convert HTTP streams to RTMP for other apps
    server {
        listen 1935;
        
        application live {
            live on;
            record off;
            
            # Pull from HTTP stream and restream as RTMP
            pull http://localhost/stream/227570 name=bein-max1 static;
            pull http://localhost/stream/227571 name=bein-max2 static;
            pull http://localhost/stream/67374 name=bein-news static;
            pull http://localhost/stream/67373 name=bein-hd static;
            
            # Allow others to pull from this RTMP server
            allow play all;
        }
    }
}
